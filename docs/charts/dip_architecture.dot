// dot docs/charts/dip_architecture.dot -Tpng > docs/charts/dip_architecture.png
// requires installation of GraphViz (brew install graphviz, or
// http://www.graphviz.org/Download..php if that doesn't work)

digraph G {
  label="Discovery Index Flow";
  labelloc=t;
  node [style=filled];

  aleph[label="Aleph Export Cron to AWS S3 Bucket", color=darkorange, fillcolor=lightgray]
  s3Event[label="S3 bucket event triggers Mario Powerup in AWS Lambda via CloudWatch", color=darkorange, fillcolor=lightgray]
  lambda[label="Mario Powerup formats command and calls Mario in AWS Fargate", color=darkorange, fillcolor=lightgray]
  fullLoad[label="Full Load: create new elasticsearch index", color=green, fillcolor=lightgray]
  dailyLoad[label="Daily Updates: use current elasticsearch index", color=green, fillcolor=lightgray]
  process[label="Process data from S3 to standard data model in ElasticSearch", color=green, fillcolor=lightgray]
  updateAlias[label="Promote new index to production if full load", color=green, fillcolor=lightgray]

  aleph -> s3Event
  s3Event -> lambda
  lambda -> fullLoad
  lambda -> dailyLoad
  dailyLoad -> process
  fullLoad -> process
  process -> updateAlias

  subgraph clusterLegend {
    label="Key";
    {
     k2[label="Process the data", color=green, fillcolor=lightgray];
     k1[label="Get the data into place", color=darkorange, fillcolor=lightgray];
     k1 -> k2 [style=invis]
     }
  }
}
